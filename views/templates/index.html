<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XTF to IFC Converter</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles5.css') }}">
</head>
<body>
    <div class="container">
        <h1 id="xtf-to-ifc-converter" class="text-4xl font-bold mb-4 text-center text-shadow">XTF to IFC Converter</h1>
        
        <div class="content-wrapper">
            <div class="left-column">
                <div class="card">
                    <div class="card-header">Upload XTF Files</div>
                    <div class="card-content">
                        <div id="file-preview-wrapper">
                            <div class="file-input-wrapper">
                                <button class="custom-file-input">Dateien auswählen</button>
                                <input type="file" id="xtf-file-input" accept=".xtf" multiple>
                            </div>
                            <div id="preview-container"></div>
                        </div>
                        <div id="file-info">Keine ausgewählt</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Configuration</div>
                    <div class="card-content">
                        <div>
                            <label for="default_sohlenkote">Default Sohlenkote</label>
                            <input type="number" id="default_sohlenkote" class="pixel-input" value="{{ config.default_sohlenkote }}">
                        </div>
                        <div>
                            <label for="default_durchmesser">Default Durchmesser</label>
                            <input type="number" id="default_durchmesser" class="pixel-input" value="{{ config.default_durchmesser }}">
                        </div>
                        <div>
                            <label for="default_hoehe">Default Höhe</label>
                            <input type="number" id="default_hoehe" class="pixel-input" value="{{ config.default_hoehe }}">
                        </div>
                        <div>
                            <label for="default_wanddicke">Default Wanddicke</label>
                            <input type="number" id="default_wanddicke" class="pixel-input" value="{{ config.default_wanddicke }}">
                        </div>
                        <div>
                            <label for="default_bodendicke">Default Bodendicke</label>
                            <input type="number" id="default_bodendicke" class="pixel-input" value="{{ config.default_bodendicke }}">
                        </div>
                        <div>
                            <label for="default_rohrdicke">Default Rohrdicke</label>
                            <input type="number" id="default_rohrdicke" class="pixel-input" value="{{ config.default_rohrdicke }}">
                        </div>
                        <div class="col-span-2 checkbox-container">
                            <input type="checkbox" id="einfaerben" class="form-checkbox" {% if config.einfaerben %}checked{% endif %}>
                            <label for="einfaerben" class="ml-2">Datenvollständigkeit farblich visualisieren</label>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Ausgabe</div>
                    <div class="card-content">
                        <button id="convert-button" class="pixel-button">Convert to IFC</button>
                        <div id="alert-container" class="mt-4"></div>
                        <div id="output-list" class="mt-4"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Switch Theme</div>
                    <div class="card-content switch-theme-buttons">
                        <button class="pixel-button" onclick="switchTheme('styles1.css')">Pixelart</button>
                        <button class="pixel-button" onclick="switchTheme('styles2.css')">Dark</button>
                        <button class="pixel-button" onclick="switchTheme('styles3.css')">Rainbow</button>
                        <button class="pixel-button" onclick="switchTheme('styles4.css')">Modern</button>
                        <button class="pixel-button" onclick="switchTheme('styles5.css')">Modern Dark</button>
                    </div>
                </div>
            </div>
            
            <div class="right-column">
                <div class="card extracted-data-card">
                    <div class="card-header">Extracted Data</div>
                    <div class="card-content">
                        <div id="extracted-data"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            2024 Martin Vanek
        </div>
    </div>

    <script>
        function switchTheme(themeName) {
            document.querySelector('link[rel="stylesheet"]').href = "{{ url_for('static', filename='css/') }}" + themeName;
        }

        document.getElementById('xtf-file-input').addEventListener('change', function(e) {
            const files = e.target.files;
            const previewContainer = document.getElementById('preview-container');
            const fileInfo = document.getElementById('file-info');
            
            previewContainer.innerHTML = '';
            
            if (files.length > 0) {
                fileInfo.textContent = `${files.length} Datei(en) ausgewählt`;
                for (let i = 0; i < files.length; i++) {
                    const fileItem = document.createElement('div');
                    fileItem.textContent = files[i].name;
                    previewContainer.appendChild(fileItem);
                }
                
                const formData = new FormData();
                formData.append('xtfFile', files[0]);
                
                fetch('/extract', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    displayExtractedData(data);
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            } else {
                fileInfo.textContent = 'Keine ausgewählt';
            }
        });

        function displayExtractedData(data) {
            const extractedDataContainer = document.getElementById('extracted-data');
            extractedDataContainer.innerHTML = '';

            const createAccordion = (title, content) => {
                const accordion = document.createElement('div');
                accordion.className = 'accordion';
                const header = document.createElement('div');
                header.className = 'accordion-header';
                header.textContent = title;
                const body = document.createElement('div');
                body.className = 'accordion-body';
                body.style.display = 'none';
                body.appendChild(content);

                header.addEventListener('click', () => {
                    body.style.display = body.style.display === 'none' ? 'block' : 'none';
                });

                accordion.appendChild(header);
                accordion.appendChild(body);
                return accordion;
            };

            const createTable = (data) => {
                const table = document.createElement('table');
                table.className = 'data-table';
                const thead = document.createElement('thead');
                const tbody = document.createElement('tbody');

                const headers = Object.keys(data[0]);
                const headerRow = document.createElement('tr');
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);

                data.forEach(item => {
                    const row = document.createElement('tr');
                    headers.forEach(header => {
                        const td = document.createElement('td');
                        td.textContent = JSON.stringify(item[header]);
                        row.appendChild(td);
                    });
                    tbody.appendChild(row);
                });

                table.appendChild(thead);
                table.appendChild(tbody);
                return table;
            };

            for (const [key, value] of Object.entries(data)) {
                if (Array.isArray(value) && value.length > 0) {
                    const table = createTable(value);
                    const accordion = createAccordion(key, table);
                    extractedDataContainer.appendChild(accordion);
                }
            }
        }

        document.getElementById('convert-button').addEventListener('click', function() {
            const formData = new FormData();
            const files = document.getElementById('xtf-file-input').files;
            
            for (let i = 0; i < files.length; i++) {
                formData.append('xtfFiles', files[i]);
            }
            
            formData.append('default_sohlenkote', document.getElementById('default_sohlenkote').value);
            formData.append('default_durchmesser', document.getElementById('default_durchmesser').value);
            formData.append('default_hoehe', document.getElementById('default_hoehe').value);
            formData.append('default_wanddicke', document.getElementById('default_wanddicke').value);
            formData.append('default_bodendicke', document.getElementById('default_bodendicke').value);
            formData.append('default_rohrdicke', document.getElementById('default_rohrdicke').value);
            formData.append('einfaerben', document.getElementById('einfaerben').checked);

            fetch('/convert', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const alertContainer = document.getElementById('alert-container');
                const outputList = document.getElementById('output-list');
                
                alertContainer.innerHTML = `<div class="alert">${data.message}</div>`;
                if (data.errors) {
                    alertContainer.innerHTML += `<div class="alert alert-error">${data.errors}</div>`;
                }
                
                outputList.innerHTML = '';
                data.downloadLinks.forEach(link => {
                    const linkElement = document.createElement('a');
                    linkElement.href = link.url;
                    linkElement.textContent = link.filename;
                    linkElement.className = 'download-link';
                    outputList.appendChild(linkElement);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('alert-container').innerHTML = `<div class="alert alert-error">Ein Fehler ist aufgetreten: ${error}</div>`;
            });
        });
    </script>
</body>
</html>